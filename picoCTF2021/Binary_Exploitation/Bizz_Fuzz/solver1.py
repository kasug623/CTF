fgets = toAddr(0x80484a0)
xrefs = currentProgram().getReferenceManager().getReferencesTo(fgets)

#a = next(xrefs).getFromAddress()
#call = getInstructionAt(a)
#print("call : ", call)
#push_buffer = getInstructionBefore(a)
#print("push_buffer : ", push_buffer)
#set_buffer = getInstructionBefore(push_buffer)
#print("set_buffer : ", set_buffer)
#push_len = getInstructionBefore(set_buffer)
#print("push_len : ", push_len)

for xref in xrefs:
    call = getInstructionAt(xref.getFromAddress())
    push_buffer = getInstructionBefore(call)
    set_buffer = getInstructionBefore(push_buffer)
    push_len = getInstructionBefore(set_buffer)
    #print("call : ", call)
    #print("push_buffer : ", push_buffer)
    #print("set_buffer : ", set_buffer)
    #print("push_len : ", push_len)
    #break

    buffer = -set_buffer.getDefaultOperandRepresentationList(1)[-2].getValue()
    length = push_len.getDefaultOperandRepresentationList(0)[0].getValue()
    if length > buffer:
        print("Found buffer overflow at ", xref.getFromAddress())

